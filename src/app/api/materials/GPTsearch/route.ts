import { NextRequest, NextResponse } from 'next/server';
import {
  ExtractedRequirements,
  MaterialComposition,
  MaterialRequirement,
  DeepResearchResult,
  DeepResearchMaterial,
  MaterialCitation,
} from '../types';

// OpenAI APIË®≠ÂÆö
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

export interface GPTSearchRequest {
  currentMaterials: MaterialComposition;
  requirements: MaterialRequirement[];
  searchQuery?: string;
}

// OpenAI Deep Research „Éó„É≠„É≥„Éó„ÉàÁîüÊàê
export function generateDeepResearchPrompt(
  requirements: ExtractedRequirements,
  currentMaterials: MaterialComposition,
  customQuery?: string
): string {
  const { composition, properties } = currentMaterials;

  // Ë¶Å‰ª∂„Çí„ÉÜ„Ç≠„Çπ„ÉàÂåñ
  const performanceReqs = [];
  if (requirements.tensileStrength) {
    performanceReqs.push(`ÂºïÂºµÂº∑Â∫¶: ${requirements.tensileStrength} N/15mm`);
  }
  if (requirements.oxygenPermeability) {
    performanceReqs.push(
      `ÈÖ∏Á¥†ÈÄèÈÅéÁéá: ${requirements.oxygenPermeability} cc/m¬≤¬∑day¬∑atm‰ª•‰∏ã`
    );
  }
  if (requirements.waterVaporPermeability) {
    performanceReqs.push(
      `Ê∞¥Ëí∏Ê∞óÈÄèÈÅéÁéá: ${requirements.waterVaporPermeability} g/m¬≤¬∑day‰ª•‰∏ã`
    );
  }
  if (requirements.heatResistance) {
    performanceReqs.push(`ËÄêÁÜ±Ê∏©Â∫¶: ${requirements.heatResistance}‚ÑÉ‰ª•‰∏ä`);
  }

  // „Ç´„Çπ„Çø„É†„ÇØ„Ç®„É™„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„ÇíÂÑ™ÂÖà
  if (customQuery) {
    return customQuery;
  }

  const prompt = `
„ÅÇ„Å™„Åü„ÅØÂåÖË£ÖÊùêÊñô„ÅÆÂ∞ÇÈñÄÁ†îÁ©∂ËÄÖ„Åß„Åô„ÄÇ‰ª•‰∏ã„ÅÆÊù°‰ª∂„ÅßÊúÄÊñ∞„ÅÆÁ†îÁ©∂Ë´ñÊñá„Å®ÂÆüÁî®Âåñ‰∫ã‰æã„ÇíË™øÊüª„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

„ÄêÁèæÂú®„ÅÆÁ¥†Êùê„Äë
- ÊßãÊàê: ${composition || '‰∏çÊòé'}
- ÁâπÊÄß: ${properties?.join(', ') || '‰∏çÊòé'}

„ÄêÊÄßËÉΩË¶Å‰ª∂„Äë
${performanceReqs.join('\n')}

„ÄêË™øÊüªÈ†ÖÁõÆ„Äë
1. 2020Âπ¥‰ª•Èôç„ÅÆÊúÄÊñ∞Á¥†ÊùêÁ†îÁ©∂„Éà„É¨„É≥„Éâ
2. „Çµ„Çπ„ÉÜ„Éä„Éñ„É´ÂåÖË£ÖÊùêÊñô„ÅÆÂÆüÁî®Âåñ‰∫ã‰æã
3. „Éê„Ç§„Ç™„Éó„É©„Çπ„ÉÅ„ÉÉ„ÇØ„ÉªÁîüÂàÜËß£ÊÄßÊùêÊñô„ÅÆÊúÄÊñ∞ÈñãÁô∫Áä∂Ê≥Å
4. „É™„Çµ„Ç§„ÇØ„É´ÂèØËÉΩ„Å™Âçò‰∏ÄÁ¥†ÊùêÂåñÊäÄË°ì
5. ‰ª£ÊõøÁ¥†Êùê„ÅÆÊÄßËÉΩÊØîËºÉ„Éá„Éº„Çø

„ÄêÁâπ„Å´ÈáçË¶ñ„Åô„ÇãÁÇπ„Äë
- „Ç´„Éº„Éú„É≥„Éã„É•„Éº„Éà„É©„É´ÈÅîÊàê„Å∏„ÅÆË≤¢ÁåÆ
- È£üÂìÅÂåÖË£Ö„Å®„Åó„Å¶„ÅÆÂÆâÂÖ®ÊÄßË™çË®º
- Â§ßÈáèÁîüÁî£ÂèØËÉΩÊÄß„Å®„Ç≥„Çπ„ÉàÁ´∂‰∫âÂäõ
- Êó¢Â≠òË®≠ÂÇô„Åß„ÅÆÂä†Â∑•ÈÅ©ÂêàÊÄß

„ÄêÂõûÁ≠îÂΩ¢Âºè„Äë
‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÊï¥ÁêÜ„Åó„Å¶ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

1. Êé®Â•®Á¥†ÊùêTOP3
   - Á¥†ÊùêÂêç:
   - Ë£ΩÈÄ†„É°„Éº„Ç´„Éº:
   - ‰∏ªË¶ÅÁâ©ÊÄßÂÄ§:
   - ‰æ°Ê†ºÂ∏Ø:
   - Â∞éÂÖ•‰∫ã‰æã:
   - ÂºïÁî®ÂÖÉ: [Ë´ñÊñáÂêç/Â†±ÂëäÊõ∏Âêç, ËëóËÄÖ/Ê©üÈñ¢, Âπ¥]

2. ÊäÄË°ì„Éà„É¨„É≥„Éâ
   - ÊúÄÊñ∞„ÅÆÁ†îÁ©∂ÈñãÁô∫ÂãïÂêë
   - ‰ªäÂæå„ÅÆÂ±ïÊúõ
   - ÂºïÁî®ÂÖÉÊÉÖÂ†±

3. ÂÆüË£Ö‰∏ä„ÅÆËÄÉÊÖÆ‰∫ãÈ†Ö
   - ÊäÄË°ìÁöÑË™≤È°å
   - „Ç≥„Çπ„ÉàÈù¢„ÅÆË™≤È°å
   - Ë¶èÂà∂„ÉªË™çË®ºË¶Å‰ª∂

4. ÂºïÁî®ÊñáÁåÆ„É™„Çπ„Éà
   ÂêÑÊùêÊñô„Å´„Å§„ÅÑ„Å¶ÂøÖ„Åö‰ª•‰∏ã„ÅÆÊÉÖÂ†±„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑÔºö
   - ÊñáÁåÆ„Çø„Ç§„Éà„É´
   - ËëóËÄÖ/Á†îÁ©∂Ê©üÈñ¢
   - Áô∫Ë°®Âπ¥
   - URLÔºà„ÅÇ„Çå„Å∞Ôºâ
   - ÊñáÁåÆ„Çø„Ç§„ÉóÔºàË´ñÊñá/ÁâπË®±/‰ºÅÊ•≠„É¨„Éù„Éº„Éà/„Ç¶„Çß„Éñ„Çµ„Ç§„ÉàÔºâ

ÂÖ∑‰ΩìÁöÑ„Å™ÊùêÊñôÂêç„ÄÅË£ΩÈÄ†„É°„Éº„Ç´„Éº„ÄÅÁâ©ÊÄß„Éá„Éº„Çø„ÄÅ„Åù„Åó„Å¶ÂøÖ„ÅöÊÉÖÂ†±Ê∫ê„ÇíÂê´„ÇÅ„Å¶ÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
`;

  console.log(
    'üß† Generated Deep Research Prompt (preview):',
    prompt.substring(0, 200) + '...'
  );
  return prompt;
}

// Deep ResearchÁµêÊûú„Çí„Éë„Éº„Çπ
export function parseDeepResearchResult(
  researchText: string
): DeepResearchResult {
  const materials: DeepResearchMaterial[] = [];
  const trends: string[] = [];
  const considerations: string[] = [];
  const citations: MaterialCitation[] = [];

  // „Çª„ÇØ„Ç∑„Éß„É≥„Åî„Å®„Å´ÂàÜÂâ≤
  const sections = researchText.split(/\n(?=\d\.)/);

  sections.forEach((section) => {
    // Êé®Â•®Á¥†Êùê„ÅÆÊäΩÂá∫ÔºàÂºïÁî®ÂÖÉÊÉÖÂ†±‰ªò„ÅçÔºâ
    if (section.includes('Êé®Â•®Á¥†Êùê') || section.includes('TOP')) {
      const materialBlocks = section.split(/Á¥†ÊùêÂêç[:Ôºö]/);

      materialBlocks.forEach((block) => {
        if (block.trim()) {
          const lines = block.split('\n');
          const materialName = lines[0]?.trim();

          if (materialName && !materialName.includes('Êé®Â•®Á¥†Êùê')) {
            // ÂºïÁî®ÂÖÉ„ÇíÊé¢„Åô
            const citationMatch = block.match(
              /ÂºïÁî®ÂÖÉ[:Ôºö]?\s*\[?([^\]\n]+)\]?/
            );
            const materialCitations: MaterialCitation[] = [];

            if (citationMatch) {
              const citationText = citationMatch[1];
              // Á∞°ÊòìÁöÑ„Å™ÂºïÁî®Ëß£Êûê
              const citationParts = citationText
                .split(',')
                .map((s) => s.trim());

              if (citationParts.length >= 2) {
                materialCitations.push({
                  title: citationParts[0],
                  authors: citationParts[1],
                  year: parseInt(citationParts[2]) || new Date().getFullYear(),
                  type: 'paper',
                });
              }
            }

            materials.push({
              name: materialName.split(/[,„ÄÅ]/)[0].trim(),
              source: 'OpenAI Deep Research',
              confidence: 'high',
              citations:
                materialCitations.length > 0 ? materialCitations : undefined,
            });
          }
        }
      });
    }

    // ÊäÄË°ì„Éà„É¨„É≥„Éâ„ÅÆÊäΩÂá∫
    if (section.includes('„Éà„É¨„É≥„Éâ') || section.includes('ÂãïÂêë')) {
      const trendLines = section
        .split('\n')
        .filter((line) => line.includes('-') || line.includes('„Éª'));
      trends.push(
        ...trendLines.map((line) => line.replace(/^[-„Éª]\s*/, '').trim())
      );
    }

    // ËÄÉÊÖÆ‰∫ãÈ†Ö„ÅÆÊäΩÂá∫
    if (section.includes('ËÄÉÊÖÆ') || section.includes('Ë™≤È°å')) {
      const considerationLines = section
        .split('\n')
        .filter((line) => line.includes('-') || line.includes('„Éª'));
      considerations.push(
        ...considerationLines.map((line) =>
          line.replace(/^[-„Éª]\s*/, '').trim()
        )
      );
    }

    // ÂºïÁî®ÊñáÁåÆ„É™„Çπ„Éà„ÅÆÊäΩÂá∫
    if (section.includes('ÂºïÁî®ÊñáÁåÆ') || section.includes('ÊñáÁåÆ„É™„Çπ„Éà')) {
      const citationLines = section.split('\n').slice(1);

      citationLines.forEach((line) => {
        if (line.trim() && !line.startsWith('#')) {
          // ÂêÑÁ®Æ„Éë„Çø„Éº„É≥„ÅßÂºïÁî®„ÇíËß£Êûê
          const patterns = [
            // „Éë„Çø„Éº„É≥1: "„Çø„Ç§„Éà„É´" (ËëóËÄÖ, Âπ¥)
            /"([^"]+)"\s*\(([^,]+),\s*(\d{4})\)/,
            // „Éë„Çø„Éº„É≥2: „Çø„Ç§„Éà„É´, ËëóËÄÖ, Âπ¥
            /^([^,]+),\s*([^,]+),\s*(\d{4})/,
            // „Éë„Çø„Éº„É≥3: [1] „Çø„Ç§„Éà„É´ - ËëóËÄÖ (Âπ¥)
            /\[\d+\]\s*([^-]+)\s*-\s*([^(]+)\s*\((\d{4})\)/,
          ];

          for (const pattern of patterns) {
            const match = line.match(pattern);
            if (match) {
              citations.push({
                title: match[1].trim(),
                authors: match[2].trim(),
                year: parseInt(match[3]),
                type: line.includes('ÁâπË®±')
                  ? 'patent'
                  : line.includes('„É¨„Éù„Éº„Éà')
                    ? 'report'
                    : 'paper',
              });
              break;
            }
          }
        }
      });
    }
  });

  // ÊùêÊñôÂêç„ÅÆ„Éë„Çø„Éº„É≥„Éû„ÉÉ„ÉÅ„É≥„Ç∞ÔºàËøΩÂä†Ôºâ
  const materialPatterns = [
    /(?:PLA|PBS|PHA|PBAT|PCL|TPS|PHB|P3HB|P4HB)/gi,
    /(?:„Éê„Ç§„Ç™|„É™„Çµ„Ç§„ÇØ„É´|ÂÜçÁîü|Bio-)(?:PET|PE|PP|PA)/gi,
    /(?:„Çª„É´„É≠„Éº„Çπ|„Ç≠„ÉÅ„É≥|„Éá„É≥„Éó„É≥|„Ç¢„É´„ÇÆ„É≥ÈÖ∏)(?:Á≥ª|„Éô„Éº„Çπ)?/gi,
    /(?:„Éù„É™‰π≥ÈÖ∏|„Éù„É™„Éí„Éâ„É≠„Ç≠„Ç∑„Ç¢„É´„Ç´„Éé„Ç®„Éº„Éà|„Éù„É™„Éñ„ÉÅ„É¨„É≥„Çµ„ÇØ„Ç∑„Éç„Éº„Éà)/gi,
  ];

  materialPatterns.forEach((pattern) => {
    const matches = researchText.match(pattern);
    if (matches) {
      matches.forEach((match) => {
        if (!materials.some((m) => m.name === match)) {
          materials.push({
            name: match,
            source: 'OpenAI Deep Research (Pattern Match)',
            confidence: 'medium',
          });
        }
      });
    }
  });

  // URLÊäΩÂá∫
  const urlPattern = /https?:\/\/[^\s]+/g;
  const urlMatches = researchText.match(urlPattern);
  if (urlMatches) {
    urlMatches.forEach((url) => {
      // Êó¢Â≠ò„ÅÆÂºïÁî®„Å´URL„ÇíËøΩÂä†
      const urlDomain = new URL(url).hostname;
      const existingCitation = citations.find(
        (c) =>
          !c.url &&
          (c.title?.toLowerCase().includes(urlDomain.split('.')[0]) ||
            c.authors?.toLowerCase().includes(urlDomain.split('.')[0]))
      );

      if (existingCitation) {
        existingCitation.url = url;
      } else {
        // Êñ∞„Åó„ÅÑÂºïÁî®„Å®„Åó„Å¶ËøΩÂä†
        citations.push({
          title: `Online Resource: ${urlDomain}`,
          url: url,
          type: 'website',
          year: new Date().getFullYear(),
        });
      }
    });
  }

  return {
    materials,
    trends,
    considerations,
    citations,
    fullText: researchText,
    timestamp: new Date().toISOString(),
  };
}

// OpenAI API„ÅßDeep ResearchÂÆüË°å
export async function executeDeepResearch(
  requirements: ExtractedRequirements,
  currentMaterials: MaterialComposition,
  customQuery?: string
): Promise<DeepResearchResult | null> {
  if (!OPENAI_API_KEY) {
    console.log('‚ö†Ô∏è OpenAI API key not configured, skipping deep research');
    return null;
  }

  try {
    console.log('üî¨ Starting OpenAI Deep Research...');
    const prompt = generateDeepResearchPrompt(
      requirements,
      currentMaterials,
      customQuery
    );

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${OPENAI_API_KEY}`,
      },
      body: JSON.stringify({
        model: 'gpt-4-turbo-preview',
        messages: [
          {
            role: 'system',
            content:
              'You are a materials science expert specializing in sustainable packaging materials. Provide detailed, accurate, and up-to-date information based on recent research and industry developments. Always respond in Japanese.',
          },
          {
            role: 'user',
            content: prompt,
          },
        ],
        temperature: 0.7,
        max_tokens: 3000,
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      console.error('OpenAI API error:', response.status, errorData);
      return null;
    }

    const data = await response.json();
    const researchResult = data.choices[0]?.message?.content;

    console.log('‚úÖ Deep Research completed');

    // Á†îÁ©∂ÁµêÊûú„ÇíÊßãÈÄ†Âåñ„Éá„Éº„Çø„Å´Â§âÊèõ
    return parseDeepResearchResult(researchResult);
  } catch (error) {
    console.error('Deep Research error:', error);
    return null;
  }
}

// GPTÊ§úÁ¥¢„ÅÆ„É°„Ç§„É≥API
export async function POST(req: NextRequest) {
  try {
    const body: GPTSearchRequest = await req.json();
    const { currentMaterials, requirements, searchQuery } = body;

    console.log('ü§ñ GPT search started...');

    // Ë¶Å‰ª∂„ÇíÁ∞°ÊòìÁöÑ„Å´ÊäΩÂá∫
    const extractedRequirements: ExtractedRequirements = {};
    requirements.forEach((req) => {
      const value = parseFloat(req.value);
      if (req.name.includes('ÂºïÂºµÂº∑Â∫¶'))
        extractedRequirements.tensileStrength = value;
      if (req.name.includes('ÈÖ∏Á¥†ÈÄèÈÅéÁéá'))
        extractedRequirements.oxygenPermeability = value;
      if (req.name.includes('Ê∞¥Ëí∏Ê∞óÈÄèÈÅéÁéá'))
        extractedRequirements.waterVaporPermeability = value;
      if (req.name.includes('ËÄêÁÜ±Ê∏©Â∫¶'))
        extractedRequirements.heatResistance = value;
    });

    // Deep ResearchÂÆüË°å
    const researchResult = await executeDeepResearch(
      extractedRequirements,
      currentMaterials,
      searchQuery
    );

    if (!researchResult) {
      return NextResponse.json(
        {
          error: 'OpenAI API not available',
          message: 'Please configure OPENAI_API_KEY in environment variables',
        },
        { status: 503 }
      );
    }

    return NextResponse.json({
      success: true,
      result: researchResult,
      metadata: {
        prompt:
          generateDeepResearchPrompt(
            extractedRequirements,
            currentMaterials,
            searchQuery
          ).substring(0, 500) + '...',
        model: 'gpt-4-turbo-preview',
        timestamp: new Date().toISOString(),
      },
    });
  } catch (error) {
    console.error('GPT search error:', error);
    return NextResponse.json(
      {
        error: 'GPT search failed',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}
